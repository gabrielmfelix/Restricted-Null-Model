# Restricted-Null-Model

[Ecological Synthesis Lab](https://marcomellolab.wordpress.com) (SintECO)

Authors: Gabriel M. Felix, Rafael B. P. Pinheiro, and Marco A. R. Mello.

E-mail: gabriel.felixf@hotmail.com.  

Published on September 3rd, 2020 (English version).

Run in R version 4.0.2 (2020-06-22) -- "Taking Off Again"

Disclaimer: You may use this script freely for commercial or non-commercial purposes at your own risk. We assume no responsibility or liability for the use of this software, convey no license or title under any patent, copyright, or mask work right to the product. We reserve the right to make changes in the software without notification. We also make no representation or warranty that such application will be suitable for the specified use without further testing or modification. If this script helps you produce any academic work (paper, book, chapter, dissertation etc.), please acknowledge the authors and cite the source.


## List of files (see further info in the respective sections)

1. PosteriorProb.R -> script for calculating interaction probabilities.
2. RestNullModel.R -> script for generating randomized matrices based on the restricted null model. 
3. ModulesFromBipartite.R -> script for extracting module composition from the output of the function computeModules from the package bipartite.
4. CompoundTopologyTest.R -> Script with the steps needed to test the compound topology hypothesis in a given interaction matrix
5. net1.txt -> example network with a compound topology.
6. Test.R -> Script with codes to test both the PosteriorProb.R and RestNullModel.R functions

## Functionality and origin

R code provided in this repository can be used to generate randomized matrices that conserve both the modular structure and the marginal totals of an orihinal matrix.

This is the **restricted null model** used in [Felix et al 2017](https://doi.org/10.1101/236687), [Pinheiro et al 2019](https://doi.org/10.1002/ecy.2796), and [Mello et al 2019](https://doi.org/10.1038/s41559-019-1002-3). It was derived from the [vaznull model](https://doi.org/10.1111/j.0030-1299.2007.15828.x).

The restricted null model is particularly useful for testing for a compound topology, i.e., a modular structure with internally nested modules. Our model allows comparing observed and expected values of nestedness between species of the same module (NODFsm), and between species of different modules (NODFdm). 

Functions for computing NODFsm and NODFdm have already been implemented in the [bipartite package for R](https://cran.r-project.org/web/packages/bipartite/index.html), as well as functions for drawing matrices with a compound topology.

In this repo, we integrated all those functions aiming to make the analysis of compound topologies easier.

In addition to functions already implemented in the package bipartite, the present code contains 3 new functions to be used sequentially:

## (1) PosteriorProb

Computes pairwise probabilities of interaction among species for a matrix with a modular structure. 

### Arguments

1. M -> matrix. The original matrix for which posterior probabilities will be calculated.

2. R.partitions -> vector of integers. It must containd info on row partitions.

3. C.partitions -> vector of integers. It must containd info on column partitions.

4. Prior.Pij -> method for computing "a priori" probabilities of interaction between species i and j. Can be defined as: 

    a. "equiprobable": probability of interaction identical to all species.  

    b. "degreeprob": probability of interaction proportional to overall species degrees.

    c. "degreeprob.byarea": probability of interaction proportional to species degrees in each matrix area - see "areas" in "Conditional.level" for a definition of matrix areas.

5. Conditional.level -> level to which conditional probability of interaction among species i and j will be conditioned. Can be defined as: 

    a. "matrix": conditional probabilities identical in all matrix areas.

    b. "modules": conditional probabilities differing between areas within and outside modules.

    c. "areas": a different set of conditional probabilities for each matrix area. A matrix area is a submatrix M[AB] of M formed by all rows of module A and all columns of module B. If A = B, then M[AB] is a module area, otherwise M[AB] is the area between two modules. Therefore, when Conditional.level =  "areas", each area have their own conditional probabilities of interaction.  

## (2) RestNullModel

Restricted null model derived from the vaznull model. Uses the pairwise probabilities generated by PosteriorProb to draw interactions for the null matrices.

### Arguments

1. M: Matrix -> matrix. The original matrix to be randomized.

2. Pij.Prob -> matrix. Matrix of probabilities with the same dimensions of M, computed by PosteriorProb.

3. Numbernulls -> integer. Number of null matrices to be produced.

4. Print.null -> logical. If simulation progress should be printed. Default is FALSE.

5. allow.degeneration -> logical. If null matrices are allowed to degenerate. Default is FALSE. If TRUE interactions are drawn without assure that all rowns and columns must have at least one interaction each.

6. return.nonrm.species -> logical. If the index of non-removed rows and columns should be returned in the output. Default is TRUE.

7. connectance -> logical. If connectance of the null matrices should be either exactly (TRUE) or aproximately (FALSE) the same as the original matrix. Default is TRUE.

8. byarea- > logical. If interactions should be drawn independently for each matrix area (i.e., in each submatrix M[ij] of M formed by all rows of module i and all columns of module j). Default is FALSE

9. R.partitions -> vector of integers. Partition of rows. Used only if byarea = TRUE.

10. C.partitions -> vector of integers. Partition of columns. Used only if byarea = TRUE.


## (3) NODAsm_NODAdm_significance 

This script explains how to use the restricted null model to test for the significance of nestedness at different network scales. The Net1.txt file represents a network with a compound topology, which will be used as an example.
